---
title: "Bank Account Fraud"
author: "Erik De Luca"
date: "`r Sys.Date()`"
output:   
  html_document:
    df_print: "paged"
    # code_folding: hide
    toc: true
    toc_color: "orchid"
    theme: united
    keep_md: true
    toc_float: true
    number_sections: true
---

# Librerie

```{r, include=FALSE}
library(gbm)
library(insuranceData)
library(randomForest)
library(ROSE)
library(dplyr)
library(tidyverse)
library(tree)
library(smotefamily)
library(ModelMetrics)
library(ggplot2)
library(viridis)
library(hrbrthemes)
library(kableExtra)
```


# Importazione dei dati

I dati sono stati importati dal  sito Kaggle al seguente link https://www.kaggle.com/datasets/sgpjesus/bank-account-fraud-dataset-neurips-2022 e si riferiscono alle frodi bancarie.
L'

```{r}
df <- read.csv("data/Base.csv") %>% 
  tibble()
df
```

## Trasformazione variabili

Trasformo la variabile `fraud_bool` da *integer* a *factor*.

```{r}
df = df %>% 
  mutate(fraud = factor(fraud_bool, labels = c("No fraud", "Fraud"))) %>%  
  select(-fraud_bool)
table(df$fraud)
```

# Analisi preliminare dei dati

Controllo della presenza di NA nel dataset.

```{r}
anyNA.data.frame(df)
```
Breve visione del dataframe, è composto da un milione di osservazioni e 32 variabili. 
Sarà necessario poner attenzione nell'ottimizzazione di alcuni comandi per la riduzione del tempo macchina nell'esecuzione degli stessi.

```{r}
df %>% 
  skimr::skim()
```



```{r}
df %>% head(100)
```

## Grafici delle variabili

### Istogramma delle variabili numeriche

```{r, warning=FALSE}
df %>%
  select(where(is.numeric)) %>% 
  mutate_all(scale) %>%  
  pivot_longer(cols = 1:9,
               names_to = "Variabili",
               values_to = "Valori") %>%  
  ggplot(aes(x = Valori, color = Variabili, fill = Variabili)) +
  geom_histogram(bins = 20, alpha = 0.6) + 
  scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("") +
    facet_wrap(~Variabili, ncol = 3)
```

```{r, warning=FALSE}
df %>%
  select(where(is.numeric)) %>% 
  mutate_all(scale) %>%  
  pivot_longer(cols = 10:18,
               names_to = "Variabili",
               values_to = "Valori") %>%  
  ggplot(aes(x = Valori, color = Variabili, fill = Variabili)) +
  geom_histogram(bins = 20, alpha = 0.6) + 
  scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("") +
    facet_wrap(~Variabili, ncol = 3)
```

```{r, warning=FALSE}
df %>%
  select(where(is.numeric)) %>% 
  mutate_all(scale) %>%  
  pivot_longer(cols = 19:26,
               names_to = "Variabili",
               values_to = "Valori") %>%  
  ggplot(aes(x = Valori, color = Variabili, fill = Variabili)) +
  geom_histogram(bins = 20, alpha = 0.6) + 
  scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("") +
    facet_wrap(~Variabili, ncol = 3)
```

### Grafici a barre delle variabili qualitative

```{r, warning=FALSE}
dfChar = df %>%
  select(where(is.character)) 
apply(matrix(1:ncol(dfChar)),1, function(indexCol)
{
  ggplot(dfChar, aes(x = get(colnames(dfChar)[indexCol]))) +
  geom_bar(fill = RColorBrewer::brewer.pal(ncol(dfChar),"Pastel2")[indexCol]) + 
  xlab(colnames(dfChar)[indexCol]) +
  ylab("Osservazioni") +
  theme_ipsum() +
  theme(legend.position="none")
}
)
   
```

## Variabile fraud con le varibili indipendenti

```{r}
# funzione per trasporre una tibble
transposeTibble = function(df) 
{
  tDf = t(df)[-1,] %>% 
    data.frame() %>% 
    tibble()
  colnames(tDf) = rownames(df)
  print(rownames(df))
  # rownames(tDf) = colnames(df)
  return(tDf)
}

b=df %>% 
  group_by(fraud) %>%
  summarise_if(is.numeric,mean) %>% 
  bind_cols(df %>% 
    group_by(fraud) %>%
    summarise_if(is.character,mode)) %>% 
  column_to_rownames("fraud...1") %>% 
  transposeTibble()
b

df %>% 
  group_by(fraud) %>%
  summarise_if(is.numeric,mean) %>% 
  bind_cols(df %>% 
    group_by(fraud) %>%
    summarise_if(is.character,mode)) %>% 
  # column_to_rownames("fraud...1") %>% 
  t() %>% 
  as.data.frame() %>% 
  tibble() %>% 
  mutate_at(vars(2:3), as.numeric)
  

df %>% 
  group_by(fraud) %>%
  summarise_if(is.numeric,mean) %>% 
  bind_cols(df %>% 
    group_by(fraud) %>%
    summarise_if(is.character,mode)) %>% 
  as.matrix() %>% 
  t() %>% 
  

  
```

